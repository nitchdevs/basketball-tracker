<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basketball Tracker</title>
    <meta name="theme-color" content="#1976d2">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .player-card {
            transition: all 0.3s ease;
        }
        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .fault-limit {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .timer {
            font-variant-numeric: tabular-nums;
        }
        .back-btn {
            transition: all 0.2s ease;
        }
        .back-btn:hover {
            background-color: #1d4ed8 !important;
        }
        .score-marker {
            position: absolute;
            top: -20px;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: white;
            padding: 1px 3px;
            border-radius: 3px;
            border: 1px solid #374151;
        }
        .score-marker-1 {
            background: #c2410c;
        }
        .score-marker-2 {
            background: #166534;
        }
        .score-marker-3 {
            background: #7c2d12;
        }
        .foul-marker {
            background: #dc2626;
        }
        .timeline-container {
            position: relative;
            height: 8px;
            background: #f87171; /* rose-400 for bench time */
            border-radius: 4px;
            overflow: hidden;
        }
        .playing-time {
            position: absolute;
            top: 0;
            height: 100%;
            background: #22c55e; /* green-500 for playing time */
            border-radius: 4px;
        }
        .score-line {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: #3b82f6; /* blue-500 for score line */
        }
        .event-dot {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #3b82f6; /* blue-500 */
        }
        .export-content {
            font-family: 'Inter', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }
        .export-header {
            text-align: center;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .export-game-info {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .export-player-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .export-player-row:last-child {
            border-bottom: none;
        }
        .export-total {
            font-weight: bold;
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .timeline-wrapper {
            margin-bottom: 20px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .timeline-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #374151;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .stat-item {
            background: #f3f4f6;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 2px;
        }
        .stat-value {
            font-weight: bold;
            font-size: 16px;
        }
        .score-1 {
            background: #c2410c;
            color: white;
        }
        .score-2 {
            background: #166534;
            color: white;
        }
        .score-3 {
            background: #7c2d12;
            color: white;
        }
        .fouls {
            background: #dc2626;
            color: white;
        }
        .download-instructions {
            margin-top: 20px;
            padding: 15px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const App = () => {
            const [activeScreen, setActiveScreen] = React.useState('home');
            const [teams, setTeams] = React.useState(function() {
                const saved = localStorage.getItem('basketball-teams');
                return saved ? JSON.parse(saved) : [
                    { id: 1, name: 'Home Team', players: [] }
                ];
            });
            const [currentTeamId, setCurrentTeamId] = React.useState(1);
            const [newPlayerName, setNewPlayerName] = React.useState('');
            const [newPlayerNumber, setNewPlayerNumber] = React.useState('');
            const [newTeamName, setNewTeamName] = React.useState('');
            
            // Game tracking state
            const [gameStarted, setGameStarted] = React.useState(false);
            const [gameTime, setGameTime] = React.useState(0);
            const [currentPeriod, setCurrentPeriod] = React.useState(1);
            const [gameTimer, setGameTimer] = React.useState(null);
            const [gameData, setGameData] = React.useState(null);
            const [showGameSummary, setShowGameSummary] = React.useState(false);
            const [showSubstitution, setShowSubstitution] = React.useState(false);
            const [selectedSubstitute, setSelectedSubstitute] = React.useState(null);
            const [playerToSubstitute, setPlayerToSubstitute] = React.useState(null);
            const [showEndGameConfirm, setShowEndGameConfirm] = React.useState(false);
            const [selectedPlayer, setSelectedPlayer] = React.useState(null);
            const [showExportModal, setShowExportModal] = React.useState(false);
            const [exportContent, setExportContent] = React.useState('');
            const [exportImage, setExportImage] = React.useState(null);
            
            // Stats state
            const [savedGames, setSavedGames] = React.useState(function() {
                const saved = localStorage.getItem('basketball-games');
                return saved ? JSON.parse(saved) : [];
            });
            const [selectedGame, setSelectedGame] = React.useState(null);

            // Setup configuration
            const [setupConfig, setSetupConfig] = React.useState(function() {
                const saved = localStorage.getItem('basketball-setup');
                const defaultConfig = {
                    periods: 4,
                    periodDuration: 600
                };
                return saved ? JSON.parse(saved) : defaultConfig;
            });

            // Save to localStorage
            React.useEffect(function() {
                localStorage.setItem('basketball-teams', JSON.stringify(teams));
            }, [teams]);

            React.useEffect(function() {
                localStorage.setItem('basketball-games', JSON.stringify(savedGames));
            }, [savedGames]);

            React.useEffect(function() {
                localStorage.setItem('basketball-setup', JSON.stringify(setupConfig));
            }, [setupConfig]);

            const currentTeam = teams.find(t => t.id === currentTeamId) || teams[0];
            const onCourtPlayers = gameData ? gameData.players.filter(p => p.onCourt) : [];
            const benchPlayers = gameData ? gameData.players.filter(p => !p.onCourt) : [];

            // Calculate total team score
            const getTotalTeamScore = function() {
                if (!gameData || !gameData.players) return 0;
                return gameData.players.reduce(function(total, player) {
                    return total + (player.score || 0);
                }, 0);
            };

            const addPlayer = function() {
                if (newPlayerName.trim() && newPlayerNumber.trim()) {
                    const numberExists = currentTeam.players.some(player => 
                        player.number === newPlayerNumber.trim()
                    );
                    
                    if (numberExists) {
                        alert('Player number ' + newPlayerNumber.trim() + ' is already in use!');
                        return;
                    }
                    
                    const updatedTeams = teams.map(team => {
                        if (team.id === currentTeamId) {
                            return {
                                ...team,
                                players: [
                                    ...team.players,
                                    {
                                        id: Date.now(),
                                        name: newPlayerName.trim(),
                                        number: newPlayerNumber.trim(),
                                        onCourt: false,
                                        playing: false,
                                        score: 0,
                                        fouls: 0,
                                        timeOnCourt: 0,
                                        timeIntervals: [],
                                        scoreEvents: [],
                                        foulEvents: []
                                    }
                                ]
                            };
                        }
                        return team;
                    });
                    setTeams(updatedTeams);
                    setNewPlayerName('');
                    setNewPlayerNumber('');
                }
            };

            const removePlayer = function(playerId) {
                const updatedTeams = teams.map(team => {
                    if (team.id === currentTeamId) {
                        return {
                            ...team,
                            players: team.players.filter(p => p.id !== playerId)
                        };
                    }
                    return team;
                });
                setTeams(updatedTeams);
            };

            const addTeam = function() {
                if (newTeamName.trim()) {
                    const newTeam = {
                        id: Date.now(),
                        name: newTeamName.trim(),
                        players: []
                    };
                    setTeams(function(prev) {
                        return [...prev, newTeam];
                    });
                    setCurrentTeamId(newTeam.id);
                    setNewTeamName('');
                }
            };

            const selectStartingPlayers = function() {
                if (currentTeam.players.length < 5) {
                    alert('You need at least 5 players to start a game!');
                    return;
                }
                
                const playersWithCourtStatus = currentTeam.players.map(p => ({
                    ...p,
                    onCourt: false,
                    playing: false,
                    timeIntervals: [],
                    scoreEvents: p.scoreEvents || [],
                    foulEvents: p.foulEvents || [],
                    lastTimeUpdate: null
                }));
                
                setGameData({
                    teamId: currentTeamId,
                    teamName: currentTeam.name,
                    startTime: Date.now(),
                    endTime: null,
                    period: 1,
                    periods: setupConfig.periods,
                    periodDuration: setupConfig.periodDuration,
                    players: playersWithCourtStatus
                });
                setActiveScreen('selectPlayers');
            };

            const confirmStartingPlayers = function() {
                const onCourtCount = gameData.players.filter(p => p.onCourt).length;
                
                if (onCourtCount !== 5) {
                    alert('You must select exactly 5 starting players!');
                    return;
                }
                
                setGameStarted(false);
                setGameTime(0);
                setCurrentPeriod(1);
                setActiveScreen('game');
            };

            const togglePlayerOnCourt = function(outPlayerId, inPlayerId) {
                if (!gameData) return;
                
                setGameData(function(prev) {
                    return {
                        ...prev,
                        players: prev.players.map(function(player) {
                            if (player.id === outPlayerId) {
                                const now = Date.now();
                                const updatedPlayer = {
                                    ...player,
                                    onCourt: false,
                                    playing: false,
                                    lastTimeUpdate: now
                                };
                                
                                if (player.playing && player.timeIntervals.length > 0 && !player.timeIntervals[player.timeIntervals.length - 1].end) {
                                    updatedPlayer.timeIntervals = player.timeIntervals.map(function(interval, idx) {
                                        return idx === player.timeIntervals.length - 1 
                                            ? { ...interval, end: now } 
                                            : interval;
                                    });
                                }
                                
                                return updatedPlayer;
                            }
                            
                            if (player.id === inPlayerId) {
                                const now = Date.now();
                                const updatedPlayer = {
                                    ...player,
                                    onCourt: true,
                                    playing: gameStarted,
                                    lastTimeUpdate: now
                                };
                                
                                if (gameStarted) {
                                    updatedPlayer.timeIntervals = [
                                        ...player.timeIntervals,
                                        { start: now, end: null }
                                    ];
                                }
                                
                                return updatedPlayer;
                            }
                            
                            return player;
                        })
                    };
                });
                
                setShowSubstitution(false);
                setSelectedSubstitute(null);
                setPlayerToSubstitute(null);
            };

            const makeSubstitution = function(outPlayer) {
                if (gameStarted) {
                    alert('Substitutions can only be made when the game is stopped!');
                    return;
                }
                
                setPlayerToSubstitute(outPlayer);
                setShowSubstitution(true);
            };

            const confirmSubstitution = function() {
                if (selectedSubstitute && playerToSubstitute) {
                    togglePlayerOnCourt(playerToSubstitute.id, selectedSubstitute.id);
                }
            };

            const togglePlayerPlaying = function(playerId) {
                if (!gameData || !gameStarted) return;
                
                setGameData(function(prev) {
                    return {
                        ...prev,
                        players: prev.players.map(function(player) {
                            if (player.id === playerId && player.onCourt) {
                                const now = Date.now();
                                const updatedPlayer = {
                                    ...player,
                                    playing: !player.playing,
                                    lastTimeUpdate: now
                                };
                                
                                if (player.playing) {
                                    if (player.timeIntervals.length > 0 && !player.timeIntervals[player.timeIntervals.length - 1].end) {
                                        updatedPlayer.timeIntervals = player.timeIntervals.map(function(interval, idx) {
                                            return idx === player.timeIntervals.length - 1 
                                                ? { ...interval, end: now } 
                                                : interval;
                                        });
                                    }
                                } else {
                                    updatedPlayer.timeIntervals = [
                                        ...player.timeIntervals,
                                        { start: now, end: null }
                                    ];
                                }
                                
                                return updatedPlayer;
                            }
                            return player;
                        })
                    };
                });
            };

            const updatePlayerScore = function(playerId, points) {
                if (!gameData) return;
                
                setGameData(function(prev) {
                    return {
                        ...prev,
                        players: prev.players.map(function(player) {
                            if (player.id === playerId) {
                                const updatedPlayer = {
                                    ...player,
                                    score: Math.max(0, player.score + points)
                                };
                                
                                // Ensure arrays exist
                                if (!updatedPlayer.scoreEvents) {
                                    updatedPlayer.scoreEvents = [];
                                }
                                
                                // Record score event
                                if (points !== 0) {
                                    const now = Date.now();
                                    const gameTime = now - prev.startTime;
                                    const period = Math.floor(gameTime / prev.periodDuration) + 1;
                                    const periodTime = (gameTime % prev.periodDuration) / 1000;
                                    
                                    updatedPlayer.scoreEvents = [
                                        ...updatedPlayer.scoreEvents,
                                        {
                                            points: points,
                                            timestamp: now,
                                            gameTime: gameTime,
                                            period: period,
                                            periodTime: periodTime
                                        }
                                    ];
                                }
                                
                                return updatedPlayer;
                            }
                            return player;
                        })
                    };
                });
            };

            const updatePlayerFouls = function(playerId, change) {
                if (!gameData) return;
                
                setGameData(function(prev) {
                    return {
                        ...prev,
                        players: prev.players.map(function(player) {
                            if (player.id === playerId) {
                                const newFouls = Math.max(0, Math.min(6, player.fouls + change));
                                
                                const updatedPlayer = {
                                    ...player,
                                    fouls: newFouls
                                };
                                
                                // Ensure arrays exist
                                if (!updatedPlayer.foulEvents) {
                                    updatedPlayer.foulEvents = [];
                                }
                                
                                // Record foul event
                                if (change !== 0) {
                                    const now = Date.now();
                                    const gameTime = now - prev.startTime;
                                    const period = Math.floor(gameTime / prev.periodDuration) + 1;
                                    const periodTime = (gameTime % prev.periodDuration) / 1000;
                                    
                                    updatedPlayer.foulEvents = [
                                        ...updatedPlayer.foulEvents,
                                        {
                                            change: change,
                                            timestamp: now,
                                            gameTime: gameTime,
                                            period: period,
                                            periodTime: periodTime
                                        }
                                    ];
                                }
                                
                                return updatedPlayer;
                            }
                            return player;
                        })
                    };
                });
            };

            // Game timer effect
            React.useEffect(function() {
                if (gameStarted && gameData && activeScreen === 'game') {
                    const timer = setInterval(function() {
                        setGameTime(function(prevTime) {
                            const newTime = prevTime + 1;
                            setGameData(function(prev) {
                                return {
                                    ...prev,
                                    players: prev.players.map(function(player) {
                                        if (player.onCourt && player.playing && player.lastTimeUpdate) {
                                            const timeDiff = Math.floor((Date.now() - player.lastTimeUpdate) / 1000);
                                            return {
                                                ...player,
                                                timeOnCourt: player.timeOnCourt + timeDiff,
                                                lastTimeUpdate: Date.now()
                                            };
                                        }
                                        return player;
                                    })
                                };
                            });
                            return newTime;
                        });
                    }, 1000);
                    
                    setGameTimer(timer);
                    return function() {
                        clearInterval(timer);
                    };
                } else {
                    if (gameTimer) {
                        clearInterval(gameTimer);
                        setGameTimer(null);
                    }
                }
            }, [gameStarted, gameData, activeScreen]);

            const toggleGameTimer = function() {
                setGameStarted(!gameStarted);
                
                if (gameData) {
                    setGameData(function(prev) {
                        return {
                            ...prev,
                            players: prev.players.map(function(player) {
                                if (player.onCourt && !gameStarted) {
                                    const now = Date.now();
                                    return {
                                        ...player,
                                        playing: true,
                                        lastTimeUpdate: now,
                                        timeIntervals: [
                                            ...player.timeIntervals,
                                            { start: now, end: null }
                                        ]
                                    };
                                } else if (player.onCourt && gameStarted) {
                                    const now = Date.now();
                                    if (player.timeIntervals.length > 0 && !player.timeIntervals[player.timeIntervals.length - 1].end) {
                                        return {
                                            ...player,
                                            playing: false,
                                            lastTimeUpdate: now,
                                            timeIntervals: player.timeIntervals.map(function(interval, idx) {
                                                return idx === player.timeIntervals.length - 1 
                                                    ? { ...interval, end: now } 
                                                    : interval;
                                            })
                                        };
                                    }
                                }
                                return player;
                            })
                        };
                    });
                }
            };

            const requestEndGame = function() {
                if (gameStarted) {
                    setShowEndGameConfirm(true);
                } else {
                    endGame();
                }
            };

            const confirmEndGame = function() {
                setShowEndGameConfirm(false);
                endGame();
            };

            const cancelEndGame = function() {
                setShowEndGameConfirm(false);
            };

            const endGame = function() {
                if (gameData) {
                    const endTime = Date.now();
                    const finalGameData = {
                        ...gameData,
                        endTime: endTime,
                        finalTime: gameTime,
                        period: currentPeriod,
                        players: gameData.players.map(function(player) {
                            let finalPlayer = { ...player };
                            if (player.timeIntervals.length > 0 && !player.timeIntervals[player.timeIntervals.length - 1].end) {
                                finalPlayer.timeIntervals = player.timeIntervals.map(function(interval, idx) {
                                    return idx === player.timeIntervals.length - 1 
                                        ? { ...interval, end: endTime } 
                                        : interval;
                                });
                            }
                            return finalPlayer;
                        })
                    };
                    
                    setSavedGames(function(prev) {
                        return [finalGameData, ...prev];
                    });
                    
                    setGameData(null);
                    setGameTime(0);
                    setGameStarted(false);
                    setCurrentPeriod(1);
                    setShowGameSummary(true);
                    setActiveScreen('home');
                }
            };

            const formatTime = function(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return mins + 'm ' + secs.toString().padStart(2, '0') + 's';
            };

            const formatTimeSimple = function(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return mins + ':' + secs.toString().padStart(2, '0');
            };

            const calculatePlayingTime = function(player, gameStartTime, gameEndTime) {
                if (!player.timeIntervals || player.timeIntervals.length === 0) {
                    return 0;
                }
                
                let totalSeconds = 0;
                
                player.timeIntervals.forEach(function(interval) {
                    const start = Math.max(interval.start, gameStartTime);
                    const end = interval.end ? Math.min(interval.end, gameEndTime) : gameEndTime;
                    
                    if (start < end) {
                        totalSeconds += Math.floor((end - start) / 1000);
                    }
                });
                
                return totalSeconds;
            };

            const getTotalPlayingTime = function(player, gameStartTime, gameEndTime) {
                return calculatePlayingTime(player, gameStartTime, gameEndTime);
            };

            const getPeriodTime = function() {
                const remaining = setupConfig.periodDuration - (gameTime % setupConfig.periodDuration);
                return formatTimeSimple(remaining);
            };

            // Sort players by number
            const sortedOnCourtPlayers = [...onCourtPlayers].sort(function(a, b) {
                return parseInt(a.number) - parseInt(b.number);
            });
            const sortedAllPlayers = [...currentTeam.players].sort(function(a, b) {
                return parseInt(a.number) - parseInt(b.number);
            });
            const sortedBenchPlayers = [...benchPlayers].sort(function(a, b) {
                return parseInt(a.number) - parseInt(b.number);
            });

            // Show back button on all screens except home
            const showBackButton = activeScreen !== 'home';

            // Custom back function for different screens
            const handleBack = function() {
                if (activeScreen === 'game') {
                    // Don't allow back during active game
                    return;
                } else if (activeScreen === 'selectPlayers') {
                    if (window.confirm('Are you sure you want to go back? Your selections will be lost.')) {
                        setActiveScreen('home');
                        setGameData(null);
                    }
                } else if (activeScreen === 'gameDetails') {
                    setActiveScreen('stats');
                } else if (activeScreen === 'playerTimeline') {
                    setActiveScreen('gameDetails');
                } else if (activeScreen === 'setup' || activeScreen === 'manageTeam' || activeScreen === 'stats') {
                    setActiveScreen('home');
                }
            };

            // Delete game
            const deleteGame = function() {
                if (selectedGame && window.confirm('Are you sure you want to delete this game?')) {
                    const gameIndex = savedGames.indexOf(selectedGame);
                    const newGames = [...savedGames];
                    newGames.splice(gameIndex, 1);
                    setSavedGames(newGames);
                    setSelectedGame(null);
                    setActiveScreen('stats');
                }
            };

            // Export game
            const exportGame = async function() {
                if (!selectedGame) return;
                
                // Calculate total team score
                const totalScore = selectedGame.players.reduce(function(total, player) {
                    return total + (player.score || 0);
                }, 0);
                
                // Calculate score breakdown
                const scoreStats = selectedGame.players.reduce(function(stats, player) {
                    if (!player.scoreEvents) return stats;
                    
                    player.scoreEvents.forEach(function(event) {
                        if (event.points === 1) stats.onePointers++;
                        if (event.points === 2) stats.twoPointers++;
                        if (event.points === 3) stats.threePointers++;
                    });
                    
                    stats.totalFouls += player.fouls;
                    return stats;
                }, { onePointers: 0, twoPointers: 0, threePointers: 0, totalFouls: 0 });
                
                // Create export content
                const exportHtml = `
                    <div class="export-content" id="export-content">
                        <div class="export-header">
                            <h1 style="font-size: 24px; margin: 0;">${selectedGame.teamName} Game Report</h1>
                            <p style="margin: 5px 0; color: #6b7280;">${new Date(selectedGame.startTime).toLocaleDateString()} • ${formatTimeSimple(selectedGame.finalTime)}</p>
                        </div>
                        
                        <div class="export-game-info">
                            <h2 style="margin: 0 0 10px 0; font-size: 18px;">Game Summary</h2>
                            <p><strong>Date:</strong> ${new Date(selectedGame.startTime).toLocaleDateString()}</p>
                            <p><strong>Duration:</strong> ${formatTimeSimple(selectedGame.finalTime)}</p>
                            <p><strong>Periods:</strong> ${selectedGame.periods}</p>
                            <p><strong>Period Duration:</strong> ${selectedGame.periodDuration/60} minutes</p>
                            <p><strong>Total Score:</strong> ${totalScore} points</p>
                        </div>
                        
                        <h2 style="margin: 0 0 10px 0; font-size: 18px;">Score & Fouls Breakdown</h2>
                        <div class="stats-grid">
                            <div class="stat-item score-1">
                                <div class="stat-label">1-Pointers</div>
                                <div class="stat-value">${scoreStats.onePointers}</div>
                            </div>
                            <div class="stat-item score-2">
                                <div class="stat-label">2-Pointers</div>
                                <div class="stat-value">${scoreStats.twoPointers}</div>
                            </div>
                            <div class="stat-item score-3">
                                <div class="stat-label">3-Pointers</div>
                                <div class="stat-value">${scoreStats.threePointers}</div>
                            </div>
                            <div class="stat-item fouls">
                                <div class="stat-label">Total Fouls</div>
                                <div class="stat-value">${scoreStats.totalFouls}</div>
                            </div>
                        </div>
                        
                        <h2 style="margin: 20px 0 10px 0; font-size: 18px;">Player Statistics</h2>
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px;">
                            ${selectedGame.players.map(function(player) {
                                const totalTime = calculatePlayingTime(player, selectedGame.startTime, selectedGame.endTime || Date.now());
                                
                                // Calculate individual player stats
                                const playerStats = { onePointers: 0, twoPointers: 0, threePointers: 0 };
                                if (player.scoreEvents) {
                                    player.scoreEvents.forEach(function(event) {
                                        if (event.points === 1) playerStats.onePointers++;
                                        if (event.points === 2) playerStats.twoPointers++;
                                        if (event.points === 3) playerStats.threePointers++;
                                    });
                                }
                                
                                return `
                                    <div class="export-player-row">
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 10px;">
                                                ${player.number}
                                            </div>
                                            <div>
                                                <div style="font-weight: bold;">${player.name}</div>
                                                <div style="font-size: 12px; color: #6b7280;">#${player.number}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div>${formatTime(totalTime)}</div>
                                            <div style="font-size: 12px;">${player.score} pts • ${player.fouls} fouls</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="export-total">
                            <div style="display: flex; justify-content: space-between;">
                                <div><strong>Total Score:</strong></div>
                                <div><strong>${totalScore} points</strong></div>
                            </div>
                        </div>
                        
                        <h2 style="margin: 20px 0 10px 0; font-size: 18px;">Player Timelines</h2>
                        ${selectedGame.players.map(function(player) {
                            const totalTime = calculatePlayingTime(player, selectedGame.startTime, selectedGame.endTime || Date.now());
                            
                            // Get playing time intervals for each period
                            const periodIntervals = Array.from({ length: selectedGame.periods }, (_, periodIndex) => periodIndex + 1).map(function(period) {
                                const periodStart = (period - 1) * selectedGame.periodDuration * 1000;
                                const periodEnd = period * selectedGame.periodDuration * 1000;
                                
                                return (player.timeIntervals || []).filter(function(interval) {
                                    const start = interval.start - selectedGame.startTime;
                                    const end = interval.end ? interval.end - selectedGame.startTime : Date.now() - selectedGame.startTime;
                                    return start < periodEnd && end > periodStart;
                                }).map(function(interval) {
                                    const start = Math.max(interval.start - selectedGame.startTime, periodStart) - periodStart;
                                    const end = interval.end 
                                        ? Math.min(interval.end - selectedGame.startTime, periodEnd) - periodStart 
                                        : selectedGame.periodDuration * 1000;
                                    return {
                                        start: start / 1000,
                                        end: end / 1000
                                    };
                                });
                            });
                            
                            return `
                                <div class="timeline-wrapper">
                                    <div class="timeline-label">
                                        #${player.number} ${player.name} - ${formatTime(totalTime)} • ${player.score} pts • ${player.fouls} fouls
                                    </div>
                                    <div style="position: relative; height: 8px; background: #f87171; border-radius: 4px; overflow: hidden;">
                                        ${periodIntervals.map(function(intervals, periodIdx) {
                                            return intervals.map(function(interval) {
                                                const width = ((interval.end - interval.start) / selectedGame.periodDuration) * 100;
                                                const left = (interval.start / selectedGame.periodDuration) * 100;
                                                return `<div style="position: absolute; top: 0; left: ${left}%; width: ${width}%; height: 100%; background: #22c55e; border-radius: 4px;"></div>`;
                                            }).join('');
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                setExportContent(exportHtml);
                setShowExportModal(true);
                
                // Wait for content to render, then capture as image
                setTimeout(async function() {
                    const exportElement = document.getElementById('export-content');
                    if (exportElement) {
                        try {
                            const canvas = await html2canvas(exportElement, {
                                scale: 2,
                                backgroundColor: null,
                                useCORS: true
                            });
                            
                            const imageData = canvas.toDataURL('image/png');
                            setExportImage(imageData);
                        } catch (error) {
                            console.error('Error capturing image:', error);
                        }
                    }
                }, 100);
            };

            // Share via email
            const shareViaEmail = function() {
                if (!exportImage) return;
                
                const subject = encodeURIComponent('Basketball Game Report');
                const body = encodeURIComponent('Please find the attached game report.');
                const mailtoLink = `mailto:?subject=${subject}&body=${body}&attach=${exportImage}`;
                
                // Create temporary link and click it
                const link = document.createElement('a');
                link.href = exportImage;
                link.download = `basketball-report-${new Date().toISOString().slice(0, 10)}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Share via WhatsApp
            const shareViaWhatsApp = function() {
                if (!exportImage) return;
                
                // Create temporary link and click it
                const link = document.createElement('a');
                link.href = exportImage;
                link.download = `basketball-report-${new Date().toISOString().slice(0, 10)}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="max-w-md mx-auto bg-white min-h-screen">
                    {/* Header */}
                    <div className="bg-blue-600 text-white p-4 shadow-md">
                        <div className="flex items-center justify-between">
                            <h1 className="text-xl font-bold">Basketball Tracker</h1>
                            {showBackButton && (
                                <button
                                    onClick={handleBack}
                                    className="px-3 py-1 bg-blue-500 rounded text-sm hover:bg-blue-400 transition-colors back-btn"
                                >
                                    Back
                                </button>
                            )}
                        </div>
                        <p className="text-blue-100 text-sm">Track your games</p>
                    </div>

                    {/* Home Screen */}
                    {activeScreen === 'home' && (
                        <div className="p-4">
                            <div className="grid grid-cols-1 gap-4 mt-6">
                                <button
                                    onClick={() => setActiveScreen('manageTeam')}
                                    className="p-6 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow text-center"
                                >
                                    <div className="text-3xl mb-2">👥</div>
                                    <h3 className="font-semibold text-gray-800">Manage Team</h3>
                                    <p className="text-sm text-gray-500 mt-1">Create and edit teams and players</p>
                                </button>
                                
                                <button
                                    onClick={selectStartingPlayers}
                                    className="p-6 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow text-center"
                                >
                                    <div className="text-3xl mb-2">🏀</div>
                                    <h3 className="font-semibold text-gray-800">Start a Game</h3>
                                    <p className="text-sm text-gray-500 mt-1">Begin tracking a new game</p>
                                </button>
                                
                                <button
                                    onClick={() => setActiveScreen('stats')}
                                    disabled={!savedGames.length}
                                    className="p-6 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow text-center disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <div className="text-3xl mb-2">📊</div>
                                    <h3 className="font-semibold text-gray-800">View Stats</h3>
                                    <p className="text-sm text-gray-500 mt-1">See game statistics and history</p>
                                </button>
                                
                                <button
                                    onClick={() => setActiveScreen('setup')}
                                    className="p-6 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow text-center"
                                >
                                    <div className="text-3xl mb-2">⚙️</div>
                                    <h3 className="font-semibold text-gray-800">Setup</h3>
                                    <p className="text-sm text-gray-500 mt-1">Configure app settings</p>
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Manage Team Screen */}
                    {activeScreen === 'manageTeam' && (
                        <div className="p-4">
                            <h2 className="text-lg font-semibold text-gray-800 mb-4">Manage Teams</h2>
                            
                            {/* Team Selection */}
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Select Team</label>
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {teams.map(function(team) {
                                        return (
                                            <button
                                                key={team.id}
                                                onClick={function() { setCurrentTeamId(team.id); }}
                                                className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                    currentTeamId === team.id
                                                        ? 'bg-blue-600 text-white'
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                {team.name}
                                            </button>
                                        );
                                    })}
                                </div>
                                
                                {/* Add New Team */}
                                <div className="flex gap-2 mb-6">
                                    <input
                                        type="text"
                                        value={newTeamName}
                                        onChange={function(e) { setNewTeamName(e.target.value); }}
                                        placeholder="New team name"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button
                                        onClick={addTeam}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors"
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>

                            {/* Current Team Players */}
                            {currentTeam && (
                                <div>
                                    <div className="flex items-center justify-between mb-3">
                                        <h3 className="font-medium text-gray-800">{currentTeam.name} Players</h3>
                                        <span className="text-sm text-gray-500">{currentTeam.players.length} players</span>
                                    </div>
                                    
                                    {currentTeam.players.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-lg">
                                            No players added yet
                                        </div>
                                    ) : (
                                        <div className="space-y-2 mb-4">
                                            {sortedAllPlayers.map(function(player) {
                                                return (
                                                    <div key={player.id} className="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg">
                                                        <div className="flex items-center space-x-3">
                                                            <div className="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                                                {player.number}
                                                            </div>
                                                            <span className="font-medium text-gray-800">{player.name}</span>
                                                        </div>
                                                        <button
                                                            onClick={function() { removePlayer(player.id); }}
                                                            className="text-red-600 hover:text-red-800 text-sm font-medium"
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}

                                    {/* Add Player Form */}
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={newPlayerName}
                                            onChange={function(e) { setNewPlayerName(e.target.value); }}
                                            placeholder="Player name"
                                            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                        <input
                                            type="number"
                                            value={newPlayerNumber}
                                            onChange={function(e) { setNewPlayerNumber(e.target.value); }}
                                            placeholder="#"
                                            className="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                        <button
                                            onClick={addPlayer}
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors"
                                        >
                                            Add
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Select Starting Players Screen */}
                    {activeScreen === 'selectPlayers' && gameData && (
                        <div className="p-4">
                            <h2 className="text-lg font-semibold text-gray-800 mb-4">Select Starting Players</h2>
                            <p className="text-sm text-gray-600 mb-4">Select exactly 5 players to start the game:</p>
                            
                            {/* Team and Setup Info */}
                            <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h3 className="font-medium text-blue-800">{currentTeam.name}</h3>
                                        <p className="text-sm text-blue-700">
                                            {setupConfig.periods} periods of {setupConfig.periodDuration/60} min each
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* All Players List */}
                            <div className="space-y-2 mb-6">
                                {sortedAllPlayers.map(function(player) {
                                    const playerInGame = gameData.players.find(function(p) { return p.id === player.id; });
                                    const isOnCourt = playerInGame ? playerInGame.onCourt : false;
                                    const isFouledOut = player.fouls >= 5;
                                    
                                    return (
                                        <div key={player.id} className={`p-3 border rounded-lg transition-all ${
                                            isOnCourt ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200'
                                        } ${isFouledOut ? 'opacity-50' : ''}`}>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-3">
                                                    <div className={`w-8 h-8 ${isFouledOut ? 'bg-red-600' : 'bg-blue-600'} text-white rounded-full flex items-center justify-center text-sm font-bold`}>
                                                        {player.number}
                                                    </div>
                                                    <div>
                                                        <div className={`font-medium ${isFouledOut ? 'text-red-800' : 'text-gray-800'}`}>
                                                            {player.name}
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            F: {player.fouls}/5
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <button
                                                    onClick={function() {
                                                        if (isFouledOut) return;
                                                        
                                                        const onCourtCount = gameData.players.filter(function(p) { return p.onCourt; }).length;
                                                        const willBeOnCourt = !isOnCourt;
                                                        
                                                        if (willBeOnCourt && onCourtCount >= 5) {
                                                            alert('Maximum of 5 players allowed on court!');
                                                            return;
                                                        }
                                                        
                                                        setGameData(function(prev) {
                                                            return {
                                                                ...prev,
                                                                players: prev.players.map(function(p) {
                                                                    return p.id === player.id 
                                                                        ? { ...p, onCourt: !isOnCourt }
                                                                        : p;
                                                                })
                                                            };
                                                        });
                                                    }}
                                                    disabled={isFouledOut}
                                                    className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
                                                        isOnCourt
                                                            ? 'bg-blue-600 text-white hover:bg-blue-700'
                                                            : isFouledOut
                                                                ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                    }`}
                                                >
                                                    {isOnCourt ? 'On Court' : 'Add'}
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            {/* Selected Count */}
                            <div className="mb-4 p-3 bg-gray-100 rounded-lg text-center">
                                <span className="font-medium">
                                    {gameData.players.filter(function(p) { return p.onCourt; }).length} / 5 players selected
                                </span>
                            </div>

                            {/* Confirm Button */}
                            <button
                                onClick={confirmStartingPlayers}
                                className="w-full py-3 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700 transition-colors"
                            >
                                Start Game with Selected Players
                            </button>
                        </div>
                    )}

                    {/* Game Tracking Screen */}
                    {activeScreen === 'game' && gameData && (
                        <div className="p-4">
                            {/* Team Header */}
                            <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h2 className="font-semibold text-blue-800">{currentTeam.name}</h2>
                                        <div className="team-score">
                                            {getTotalTeamScore()} points
                                        </div>
                                    </div>
                                    <div className="text-sm text-blue-700">
                                        Period {currentPeriod}/{setupConfig.periods}
                                    </div>
                                </div>
                            </div>

                            {/* Game Timer */}
                            <div className="text-center mb-6">
                                <div className="bg-gray-800 text-white rounded-lg p-4 mb-3">
                                    <div className="text-3xl font-mono">{getPeriodTime()}</div>
                                    <div className="text-sm text-gray-300 mt-1">Game Clock</div>
                                </div>
                                <button
                                    onClick={toggleGameTimer}
                                    className={`px-8 py-3 rounded-lg font-medium text-white text-sm transition-all ${
                                        gameStarted ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'
                                    }`}
                                >
                                    {gameStarted ? 'Pause Game' : 'Start Game'}
                                </button>
                            </div>

                            {/* On Court Players */}
                            <div className="mb-6">
                                <h3 className="font-medium text-gray-800 mb-3">On Court Players</h3>
                                <div className="space-y-3">
                                    {sortedOnCourtPlayers.map(function(player) {
                                        const playerInGame = gameData.players.find(function(p) { return p.id === player.id; });
                                        const totalTime = getTotalPlayingTime(playerInGame, gameData.startTime, Date.now());
                                        const isFouledOut = playerInGame.fouls >= 5;
                                        const isCloseToFoulingOut = playerInGame.fouls >= 4;
                                        
                                        return (
                                            <div key={player.id} className={`p-4 border rounded-lg transition-all ${
                                                isFouledOut ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'
                                            }`}>
                                                <div className="flex items-center justify-between mb-3">
                                                    <div className="flex items-center space-x-3">
                                                        <div 
                                                            onClick={function() { gameStarted && togglePlayerPlaying(player.id); }}
                                                            className={`cursor-pointer ${isFouledOut ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                        >
                                                            <div className="flex items-center space-x-3">
                                                                <div className={`w-10 h-10 ${isFouledOut ? 'bg-red-600' : 'bg-blue-600'} text-white rounded-full flex items-center justify-center text-sm font-bold`}>
                                                                    {player.number}
                                                                </div>
                                                                <div>
                                                                    <div className={`font-medium ${isFouledOut ? 'text-red-800' : 'text-gray-800'}`}>
                                                                        {player.name}
                                                                    </div>
                                                                    <div className="text-xs text-gray-500 timer">
                                                                        {formatTime(totalTime)}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex items-center space-x-2">
                                                        <button
                                                            onClick={function() { makeSubstitution(player); }}
                                                            disabled={gameStarted}
                                                            className={`px-2 py-1 text-xs font-medium rounded ${
                                                                gameStarted 
                                                                    ? 'bg-gray-200 text-gray-500 cursor-not-allowed' 
                                                                    : 'bg-orange-100 text-orange-800 hover:bg-orange-200'
                                                            }`}
                                                        >
                                                            Sub
                                                        </button>
                                                        <div className={`text-sm font-medium px-3 py-1.5 rounded text-center min-w-16 ${
                                                            isCloseToFoulingOut 
                                                                ? 'bg-yellow-100 text-yellow-800 animate-pulse' 
                                                                : 'bg-gray-100 text-gray-800'
                                                        }`}>
                                                            F: {playerInGame.fouls}/5
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Action buttons */}
                                                <div className="grid grid-cols-6 gap-1 mb-2">
                                                    <button
                                                        onClick={function() { updatePlayerScore(player.id, 1); }}
                                                        className="py-2 bg-green-100 text-green-800 rounded text-sm font-medium hover:bg-green-200 transition-colors"
                                                    >
                                                        +1
                                                    </button>
                                                    <button
                                                        onClick={function() { updatePlayerScore(player.id, 2); }}
                                                        className="py-2 bg-green-100 text-green-800 rounded text-sm font-medium hover:bg-green-200 transition-colors"
                                                    >
                                                        +2
                                                    </button>
                                                    <button
                                                        onClick={function() { updatePlayerScore(player.id, 3); }}
                                                        className="py-2 bg-green-100 text-green-800 rounded text-sm font-medium hover:bg-green-200 transition-colors"
                                                    >
                                                        +3
                                                    </button>
                                                    <button
                                                        onClick={function() { updatePlayerFouls(player.id, 1); }}
                                                        className="py-2 bg-red-100 text-red-800 rounded text-sm font-medium hover:bg-red-200 transition-colors"
                                                    >
                                                        F
                                                    </button>
                                                    <button
                                                        onClick={function() { updatePlayerScore(player.id, -1); }}
                                                        className="py-2 bg-gray-100 text-gray-800 rounded text-sm font-medium hover:bg-gray-200 transition-colors"
                                                    >
                                                        -1
                                                    </button>
                                                    <button
                                                        onClick={function() { updatePlayerFouls(player.id, -1); }}
                                                        className="py-2 bg-gray-100 text-gray-800 rounded text-sm font-medium hover:bg-gray-200 transition-colors"
                                                    >
                                                        -F
                                                    </button>
                                                </div>
                                                
                                                {/* Score display */}
                                                <div className="flex justify-between items-center">
                                                    <div className={`text-2xl font-bold ${playerInGame.score > 0 ? 'text-blue-600' : 'text-gray-400'}`}>
                                                        {playerInGame.score}
                                                    </div>
                                                    <div className="text-sm text-gray-500">
                                                        points
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* End Game Button */}
                            <div className="pt-6 border-t border-gray-200">
                                <button
                                    onClick={requestEndGame}
                                    className="w-full py-3 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700 transition-colors"
                                >
                                    End Game
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Substitution Modal */}
                    {showSubstitution && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-md w-full">
                                <div className="p-4 border-b border-gray-200">
                                    <h3 className="font-semibold text-gray-800">Make Substitution</h3>
                                    <p className="text-sm text-gray-600 mt-1">
                                        Replace {playerToSubstitute ? playerToSubstitute.name : ''} #{playerToSubstitute ? playerToSubstitute.number : ''}
                                    </p>
                                </div>
                                
                                <div className="p-4 max-h-60 overflow-y-auto">
                                    <p className="text-sm text-gray-600 mb-3">Select player to enter:</p>
                                    <div className="space-y-2">
                                        {sortedBenchPlayers.map(function(player) {
                                            const playerInGame = gameData ? gameData.players.find(function(p) { return p.id === player.id; }) : null;
                                            const isFouledOut = playerInGame ? playerInGame.fouls >= 5 : false;
                                            return (
                                                <div
                                                    key={player.id}
                                                    onClick={function() { !isFouledOut && setSelectedSubstitute(player); }}
                                                    className={`p-3 border rounded-lg cursor-pointer transition-all ${
                                                        selectedSubstitute && selectedSubstitute.id === player.id
                                                            ? 'border-blue-500 bg-blue-50'
                                                            : 'border-gray-200 hover:border-gray-300'
                                                    } ${isFouledOut ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center space-x-3">
                                                            <div className={`w-8 h-8 ${isFouledOut ? 'bg-red-600' : 'bg-blue-600'} text-white rounded-full flex items-center justify-center text-sm font-bold`}>
                                                                {player.number}
                                                            </div>
                                                            <div>
                                                                <div className={`font-medium ${isFouledOut ? 'text-red-800' : 'text-gray-800'}`}>
                                                                    {player.name}
                                                                </div>
                                                                <div className="text-xs text-gray-500">
                                                                    F: {playerInGame ? playerInGame.fouls : 0}/5
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {selectedSubstitute && selectedSubstitute.id === player.id && (
                                                            <div className="text-blue-600 font-bold">✓</div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                
                                <div className="p-4 border-t border-gray-200 flex space-x-3">
                                    <button
                                        onClick={function() {
                                            setShowSubstitution(false);
                                            setSelectedSubstitute(null);
                                            setPlayerToSubstitute(null);
                                        }}
                                        className="flex-1 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmSubstitution}
                                        disabled={!selectedSubstitute}
                                        className="flex-1 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        Confirm
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* End Game Confirmation Modal */}
                    {showEndGameConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-md w-full">
                                <div className="p-4 border-b border-gray-200">
                                    <h3 className="font-semibold text-gray-800">Confirm End Game</h3>
                                </div>
                                
                                <div className="p-4">
                                    <p className="text-gray-600 mb-4">
                                        The game is still running. Are you sure you want to end it now?
                                    </p>
                                    <div className="space-y-3">
                                        <button
                                            onClick={confirmEndGame}
                                            className="w-full py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition-colors"
                                        >
                                            Yes, End Game
                                        </button>
                                        <button
                                            onClick={cancelEndGame}
                                            className="w-full py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors"
                                        >
                                            Continue Game
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Stats Screen */}
                    {activeScreen === 'stats' && (
                        <div className="p-4">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-lg font-semibold text-gray-800">Game Statistics</h2>
                                <button
                                    onClick={function() { setActiveScreen('home'); }}
                                    className="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors"
                                >
                                    Back
                                </button>
                            </div>

                            {savedGames.length === 0 ? (
                                <div className="text-center py-12 text-gray-500">
                                    <div className="text-6xl mb-4">📊</div>
                                    <p className="text-lg font-medium">No games tracked yet</p>
                                    <p className="text-sm">Start tracking games to view statistics</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {savedGames.map(function(game, index) {
                                        return (
                                            <div key={index} className="border border-gray-200 rounded-lg p-4">
                                                <div className="flex items-center justify-between mb-3">
                                                    <div>
                                                        <h3 className="font-medium text-gray-800">{game.teamName}</h3>
                                                        <p className="text-sm text-gray-500">
                                                            {new Date(game.startTime).toLocaleDateString()} • 
                                                            {game.periods} periods • 
                                                            {formatTimeSimple(game.finalTime)}
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={function() {
                                                            setSelectedGame(game);
                                                            setActiveScreen('gameDetails');
                                                        }}
                                                        className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors"
                                                    >
                                                        Details
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Game Details Screen */}
                    {activeScreen === 'gameDetails' && selectedGame && (
                        <div className="p-4">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-lg font-semibold text-gray-800">Game Details</h2>
                                <button
                                    onClick={function() { setActiveScreen('stats'); }}
                                    className="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors"
                                >
                                    Back
                                </button>
                            </div>

                            {/* Game Info */}
                            <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h3 className="font-medium text-blue-800 mb-2">{selectedGame.teamName}</h3>
                                <div className="space-y-2 text-sm text-blue-700">
                                    <p>Date: {new Date(selectedGame.startTime).toLocaleDateString()}</p>
                                    <p>Duration: {formatTimeSimple(selectedGame.finalTime)}</p>
                                    <p>Periods: {selectedGame.periods}</p>
                                    <p>Period Duration: {selectedGame.periodDuration/60} minutes</p>
                                </div>
                            </div>

                            {/* Player List */}
                            <div className="space-y-3">
                                {selectedGame.players.map(function(player) {
                                    const playerInGame = selectedGame.players.find(function(p) { return p.id === player.id; });
                                    const totalTime = calculatePlayingTime(playerInGame, selectedGame.startTime, selectedGame.endTime || Date.now());
                                    
                                    return (
                                        <div key={player.id} className="p-4 border rounded-lg bg-white border-gray-200">
                                            <div className="flex items-center justify-between mb-2">
                                                <div className="flex items-center space-x-3">
                                                    <div className="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                                        {player.number}
                                                    </div>
                                                    <div>
                                                        <div className="font-medium text-gray-800">{player.name}</div>
                                                        <div className="text-xs text-gray-500">
                                                            {formatTime(totalTime)} • {playerInGame.fouls} fouls
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-lg font-bold text-blue-600">{playerInGame.score}</div>
                                                    <div className="text-xs text-gray-500">points</div>
                                                </div>
                                            </div>
                                            
                                            <button
                                                onClick={function() {
                                                    setSelectedPlayer(playerInGame);
                                                    setActiveScreen('playerTimeline');
                                                }}
                                                className="w-full mt-2 py-2 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200 transition-colors"
                                            >
                                                View Timeline
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>

                            {/* Game Actions */}
                            <div className="mt-6 pt-6 border-t border-gray-200">
                                <div className="flex space-x-3">
                                    <button
                                        onClick={deleteGame}
                                        className="flex-1 py-3 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors"
                                    >
                                        Delete Game
                                    </button>
                                    <button
                                        onClick={exportGame}
                                        className="flex-1 py-3 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors"
                                    >
                                        Export Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Player Timeline Screen */}
                    {activeScreen === 'playerTimeline' && selectedPlayer && selectedGame && (
                        <div className="p-4">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-lg font-semibold text-gray-800">Player Timeline</h2>
                                <button
                                    onClick={function() { setActiveScreen('gameDetails'); }}
                                    className="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors"
                                >
                                    Back
                                </button>
                            </div>

                            {/* Player Info */}
                            <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div className="flex items-center space-x-3">
                                    <div className="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center text-lg font-bold">
                                        {selectedPlayer.number}
                                    </div>
                                    <div>
                                        <h3 className="font-semibold text-blue-800">{selectedPlayer.name}</h3>
                                        <div className="text-sm text-blue-700">
                                            {selectedPlayer.score} points • {selectedPlayer.fouls} fouls
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Timeline for each period */}
                            {Array.from({ length: selectedGame.periods }, function(_, periodIndex) { return periodIndex + 1; }).map(function(period) {
                                const periodStart = (period - 1) * selectedGame.periodDuration * 1000;
                                const periodEnd = period * selectedGame.periodDuration * 1000;
                                const periodDuration = selectedGame.periodDuration;
                                
                                // Get playing time intervals for this period
                                const periodIntervals = (selectedPlayer.timeIntervals || []).filter(function(interval) {
                                    const start = interval.start - selectedGame.startTime;
                                    const end = interval.end ? interval.end - selectedGame.startTime : Date.now() - selectedGame.startTime;
                                    return start < periodEnd && end > periodStart;
                                }).map(function(interval) {
                                    const start = Math.max(interval.start - selectedGame.startTime, periodStart) - periodStart;
                                    const end = interval.end 
                                        ? Math.min(interval.end - selectedGame.startTime, periodEnd) - periodStart 
                                        : periodDuration * 1000;
                                    return {
                                        start: start / 1000,
                                        end: end / 1000
                                    };
                                });

                                // Get score events for this period
                                const periodScoreEvents = (selectedPlayer.scoreEvents || []).filter(function(event) {
                                    return event && event.period === period && event.points !== 0;
                                }).map(function(event) {
                                    const position = (event.periodTime / periodDuration) * 100;
                                    return {
                                        points: event.points,
                                        position: position
                                    };
                                });

                                // Get foul events for this period
                                const periodFoulEvents = (selectedPlayer.foulEvents || []).filter(function(event) {
                                    return event && event.period === period;
                                }).map(function(event) {
                                    const position = (event.periodTime / periodDuration) * 100;
                                    return {
                                        change: event.change,
                                        position: position
                                    };
                                });

                                return (
                                    <div key={period} className="mb-6">
                                        <h3 className="font-medium text-gray-800 mb-3">Period {period}</h3>
                                        <div className="bg-gray-100 rounded-lg p-4">
                                            {/* Timeline */}
                                            <div className="timeline-container mb-4">
                                                {/* Playing time segments */}
                                                {periodIntervals.map(function(interval, idx) {
                                                    const width = ((interval.end - interval.start) / periodDuration) * 100;
                                                    const left = (interval.start / periodDuration) * 100;
                                                    return (
                                                        <div
                                                            key={idx}
                                                            className="playing-time"
                                                            style={{ left: `${left}%`, width: `${width}%` }}
                                                        ></div>
                                                    );
                                                })}
                                                
                                                {/* Score events */}
                                                {periodScoreEvents.map(function(event, idx) {
                                                    return (
                                                        <div key={`score-${idx}`}>
                                                            <div
                                                                className="score-line"
                                                                style={{ left: `${event.position}%` }}
                                                            ></div>
                                                            <div
                                                                className={`score-marker score-marker-${event.points}`}
                                                                style={{ left: `${event.position}%` }}
                                                            >
                                                                {event.points}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                
                                                {/* Foul events */}
                                                {periodFoulEvents.map(function(event, idx) {
                                                    return (
                                                        <div key={`foul-${idx}`}>
                                                            <div
                                                                className="score-line"
                                                                style={{ left: `${event.position}%` }}
                                                            ></div>
                                                            <div
                                                                className="score-marker foul-marker"
                                                                style={{ left: `${event.position}%` }}
                                                            >
                                                                F
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                
                                                {/* Period markers */}
                                                <div className="absolute top-0 left-0 h-full w-0.5 bg-gray-400"></div>
                                                <div className="absolute top-0 right-0 h-full w-0.5 bg-gray-400"></div>
                                                
                                                {/* Time markers */}
                                                {Array.from({ length: 6 }, function(_, i) { return i * 2; }).map(function(minute) {
                                                    return (
                                                        <div key={minute} className="absolute top-0 h-full w-0.5 bg-gray-300" style={{ left: `${(minute * 60) / periodDuration * 100}%` }}>
                                                            <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-gray-600">
                                                                {minute}'
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            
                                            {/* Events */}
                                            <div className="text-sm text-gray-600">
                                                {periodIntervals.length > 0 ? (
                                                    <p>Played {formatTime(periodIntervals.reduce(function(total, interval) { return total + (interval.end - interval.start); }, 0))}</p>
                                                ) : (
                                                    <p>Did not play</p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Setup Screen */}
                    {activeScreen === 'setup' && (
                        <div className="p-4">
                            <h2 className="text-lg font-semibold text-gray-800 mb-6">Setup</h2>
                            
                            <div className="space-y-6">
                                <div className="p-4 border border-gray-200 rounded-lg">
                                    <h3 className="font-medium text-gray-800 mb-3">Game Configuration</h3>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Number of Periods
                                            </label>
                                            <input
                                                type="number"
                                                min="1"
                                                max="10"
                                                value={setupConfig.periods}
                                                onChange={function(e) { 
                                                    setSetupConfig(function(prev) {
                                                        return {
                                                            ...prev,
                                                            periods: parseInt(e.target.value) || 1
                                                        };
                                                    });
                                                }}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">
                                                Default: 4 (basketball), 2 (soccer), 3 (hockey)
                                            </p>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Duration of Each Period (minutes)
                                            </label>
                                            <input
                                                type="number"
                                                min="1"
                                                max="30"
                                                value={setupConfig.periodDuration / 60}
                                                onChange={function(e) { 
                                                    setSetupConfig(function(prev) {
                                                        return {
                                                            ...prev,
                                                            periodDuration: (parseInt(e.target.value) || 1) * 60
                                                        };
                                                    });
                                                }}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">
                                                Default: 10 minutes for basketball
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="p-4 border border-gray-200 rounded-lg">
                                    <h3 className="font-medium text-gray-800 mb-2">Data Management</h3>
                                    <p className="text-sm text-gray-600 mb-3">All data is saved locally on your device.</p>
                                    <button
                                        onClick={function() {
                                            if (window.confirm('Are you sure you want to reset all data? This cannot be undone!')) {
                                                setTeams([{ id: 1, name: 'Home Team', players: [] }]);
                                                setSavedGames([]);
                                                setCurrentTeamId(1);
                                                setSetupConfig({
                                                    periods: 4,
                                                    periodDuration: 600
                                                });
                                                alert('All data has been reset to defaults!');
                                            }
                                        }}
                                        className="px-4 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition-colors"
                                    >
                                        Reset All Data
                                    </button>
                                </div>
                                
                                <div className="p-4 border border-gray-200 rounded-lg">
                                    <h3 className="font-medium text-gray-800 mb-2">About</h3>
                                    <p className="text-sm text-gray-600">
                                        Basketball Tracker v1.0<br/>
                                        Track your games, players, and statistics.<br/>
                                        Configurable for different sports.<br/>
                                        Data is saved locally on your device.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Game Summary Modal */}
                    {showGameSummary && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-md w-full">
                                <div className="p-4 border-b border-gray-200">
                                    <h3 className="font-semibold text-gray-800 text-center">Game Saved!</h3>
                                </div>
                                
                                <div className="p-4">
                                    <div className="text-center py-6">
                                        <div className="text-6xl mb-4">✅</div>
                                        <p className="text-gray-600 mb-4">Your game has been successfully saved.</p>
                                        <div className="space-y-2">
                                            <button
                                                onClick={function() {
                                                    setShowGameSummary(false);
                                                    setActiveScreen('home');
                                                }}
                                                className="w-full py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors"
                                            >
                                                Back to Home
                                            </button>
                                            <button
                                                onClick={function() {
                                                    setShowGameSummary(false);
                                                    setActiveScreen('stats');
                                                }}
                                                className="w-full py-2 bg-gray-600 text-white rounded-lg text-sm font-medium hover:bg-gray-700 transition-colors mt-2"
                                            >
                                                View Statistics
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Export Modal */}
                    {showExportModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-lg w-full max-h-90vh overflow-y-auto">
                                <div className="p-4 border-b border-gray-200 flex items-center justify-between">
                                    <h3 className="font-semibold text-gray-800">Export Game Report</h3>
                                    <button
                                        onClick={function() { 
                                            setShowExportModal(false); 
                                            setExportImage(null);
                                        }}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        ✕
                                    </button>
                                </div>
                                
                                <div className="p-4">
                                    {exportImage ? (
                                        <div>
                                            <img src={exportImage} alt="Game Report" style={{width: '100%', height: 'auto'}} />
                                            <div className="download-instructions">
                                                <p>The image has been prepared for download. Click one of the buttons below to share:</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-8">
                                            <div className="text-4xl mb-4">🔄</div>
                                            <p>Generating report image...</p>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="p-4 border-t border-gray-200 flex space-x-3">
                                    <button
                                        onClick={shareViaEmail}
                                        disabled={!exportImage}
                                        className="flex-1 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        Download & Email
                                    </button>
                                    <button
                                        onClick={shareViaWhatsApp}
                                        disabled={!exportImage}
                                        className="flex-1 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        Download & WhatsApp
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the app
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>